<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <script src="https://kit.fontawesome.com/8a64ae10ae.js" crossorigin="anonymous"></script>
  <style>
        body {
            font-family: 'Arial', sans-serif;
            background-image: radial-gradient(circle, #A0C4F2, #F2F9FF);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 10px;
            border-bottom: 2px solid #4E64A6;
            width: 98%;
            margin: 0 auto;
        }
       .menu, .user-area {
            flex: 1;
            display: flex;
            justify-content: flex-start; /* 왼쪽 정렬 */
        }

        .menu {
            justify-content: flex-start; /* 왼쪽 정렬 */
        }

        .logo {
            flex: 1;
            display: flex;
            justify-content: center; /* 가운데 정렬 */
        }

        .user-area {
            justify-content: flex-end; /* 오른쪽 정렬 */
        }
        #createBook{
            text-decoration: none;
            margin: 0 10px;
            padding: 8px 8px;
            border-radius: 5px;
            font-size: 18px;
            color: #4E64A6;
        }
        #quotes{
            text-decoration: none;
            margin: 0 10px;
            padding: 8px 8px;
            border-radius: 5px;
            font-size: 18px;
            color: #4E64A6;
        }
        #home{
            text-decoration: none;
            margin: 0 10px;
            padding: 4px 4px;
            border-radius: 5px;
            font-size: 18px;
            color: #4E64A6;
        }

        #myPage {
            text-decoration: none;
            margin: 0 10px;
            padding: 11px 15px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            font-size: 18px;
            color: #4E64A6;
        }
        #signup {
            text-decoration: none;
            margin: 0 10px;
            padding: 11px 15px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            font-size: 18px;
            color: #4E64A6;
        }
        #login {
            text-decoration: none;
            margin: 0 10px;
            padding: 11px 15px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.2);
            font-size: 18px;
            color: #4E64A6;
        }
        #logout {
            text-decoration: none;
            margin: 0 10px;
            padding: 11px 15px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            font-size: 18px;
            color: #4E64A6;
        }

        .form-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .form-group {
            margin: 10px;
        }

        .selected-tags {
          margin-top: 10px;
        }
        .selected-tag {
          display: inline-block;
          background-color: rgba(255, 255, 255, 0.3);
          padding: 5px 10px;
          font-size: 16px;
          margin-right: 5px;
          border-radius: 5px;
        }
        .cancel-btn {
          margin-left: 5px;
          cursor: pointer;
        }

        #content {
            width: 500px;
            height: 300px;
            text-align: center;
            font-size: 16px;
            background-color: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 5px;
        }

        #page {
            width: 483px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            padding: 10px;
            border: none;
            margin-bottom: 10px;
        }

        #selectedTags{
            margin-left: 10px;
            margin-bottom: 10px;
        }
        #textInput{
            border-radius: 5px 5px 0 0;
            width: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border: none;
            margin-left: 10px;
        }
        #tagList{
            width: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px;
            font-size: 16px;
            border: none;
            margin-left: 10px;
            margin-bottom: 10px;
        }

        #quote-create-btn {
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border: none;
            margin-left: 10px;
            margin-bottom: 10px;
        }
        label{
          font-family: 'Arial', sans-serif;
        }
        table {
            width: 100%; /* 조절 가능한 table width 값 */
            margin-top: 40px; /* 조절 가능한 margin 값 */
            margin-bottom: 10px;
            border-collapse: collapse;
            color: #4E64A6;
            border-radius: 5px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.2);
        }
        th, td {
            text-align: center;
            border-radius: 10px;/* 테두리 선 추가 */
            padding: 8px; /* 셀 안의 여백 추가 */
        }
    </style>
</head>

<body>
<div class="container">
  <div class="header">
    <div class="menu">
      <a id="createBook" href="/books/create">Create Book</a>
      <a id="quotes" href="/quotes">All Quotes</a>
    </div>
    <div class="logo">
      <a id="home" href="/">
        <i class="fa-solid fa-house"></i>
      </a>
    </div>
    <div class="user-area">
      <th:block th:if="${loggedIn}">
        <a id="myPage" href="/myPage">MyPage</a>
        <a id="logout" href="/" class="login">Logout</a>
      </th:block>
      <th:block th:unless="${loggedIn}">
        <a id="signup" href="/signup">SignUp</a>
        <a id="login" href="/login" class="logout">LogIn</a>
      </th:block>
    </div>
  </div>
  <div class="form-container">
    <input type="hidden" id="bookId" th:value="${book.id}" />
    <input type="hidden" id="userId" th:value="${user.id}" />
    <div id="book-info">
      <table class="table table-striped">
        <thead>
      <tr>
        <th>TITLE</th>
        <td th:text="${book.title}"></td>
        <th>AUTHOR</th>
        <td th:text="${book.author}"></td>
        <th>PUBLISHER</th>
        <td th:text="${book.publisher}"></td>
      </tr>
        </thead>
        </table>
    </div>
    <form class="form-inline">
      <div class="form-group">
        <input type="text" id="page" placeholder="page" />
      </div>
      <div class="form-group">
        <input type="text" id="content"/>
      </div>
      <div>
        <input type="text" id="textInput" placeholder="책갈피를 표현하는 태그를 걸어보세요.">
        <div id="tagList">
          <div th:each="tag : ${tags}" th:id="'tag-' + ${tag.id}" class="tag" th:text="${tag.tag}" style="display:none;"></div>
        </div>
      </div>
      <div class="selected-tags" id="selectedTags"></div>
      <div>
        <button id="quote-create-btn" type="submit" class="btn btn-primary">등록</button>
      </div>
    </form>
  </div>
</div>
<!-- /container -->
</body>

<script>
// 입력 필드 요소 가져오기
const inputField = document.getElementById('textInput');
// Thymeleaf의 태그들을 담고 있는 요소 가져오기
const tagElements = document.querySelectorAll('#tagList .tag');
// 선택된 태그들을 표시할 영역 요소 가져오기
const selectedTagsContainer = document.getElementById('selectedTags');

// 선택된 태그를 담을 배열 초기화
let selectedTags = [];
let tagIds = [];

// 입력 필드에 input 이벤트 리스너 추가
inputField.addEventListener('input', function(event) {
    const inputValue = event.target.value.toLowerCase(); // 입력된 값
    tagElements.forEach(function(tagElement) {
        const tagValue = tagElement.textContent.toLowerCase(); // Thymeleaf 태그의 값
        if (tagValue.includes(inputValue)) {
            tagElement.style.display = 'block'; // 일치하는 태그는 표시
        } else {
            tagElement.style.display = 'none'; // 일치하지 않는 태그는 숨김
        }
    });
});

// 각 태그에 클릭 이벤트 리스너 추가
tagElements.forEach(function(tagElement) {
    tagElement.addEventListener('click', function(event) {
      const selectedValue = event.target.textContent; // 클릭한 태그의 값
      const selectedId = event.target.getAttribute('id').replace('tag-', ''); // Thymeleaf의 id에서 'tag-'를 제거하여 id 추출
      // 선택된 태그 배열에 추가
      selectedTags.push(selectedValue);
      tagIds.push(selectedId); // 선택된 태그의 id를 추가
      // 선택된 태그들을 표시할 영역 업데이트
      updateSelectedTags();
  });
});

// 선택된 태그들을 표시하는 함수
function updateSelectedTags() {
    selectedTagsContainer.innerHTML = ''; // 표시 영역 초기화
    selectedTags.forEach(function(tag, index) {
        // 각 선택된 태그를 생성하여 표시 영역에 추가
        const tagElement = document.createElement('div');
        tagElement.classList.add('selected-tag');
        tagElement.textContent = tag;
        selectedTagsContainer.appendChild(tagElement);

        // 취소 버튼 생성
        const cancelButton = document.createElement('span');
        cancelButton.textContent = 'x';
        cancelButton.classList.add('cancel-btn');
        cancelButton.addEventListener('click', function() {
            // 선택된 태그 배열에서 해당 태그 제거
            selectedTags.splice(index, 1);
            // 선택된 태그의 id도 함께 제거
            tagIds.splice(index, 1);
            // 선택된 태그들을 표시할 영역 업데이트
            updateSelectedTags();
        });
        // 취소 버튼을 선택된 태그 옆에 추가
        tagElement.appendChild(cancelButton);
    });
}

const quoteCreateButton = document.getElementById('quote-create-btn');
var bookId = document.getElementById('bookId').value;
var userId = document.getElementById('userId').value;

if (quoteCreateButton) {
    quoteCreateButton.addEventListener('click', event => {
        // tagIds를 쿼리 파라미터 형식으로 변환
        const tagParams = tagIds.map(tagId => `tagId=${tagId}`).join('&');
        // 최종 URL 생성
        const url = `/api/books/${bookId}/quotes/${userId}?${tagParams}`;
        var body = JSON.stringify({
                content: document.getElementById('content').value,
                page: document.getElementById('page').value
        });
        event.preventDefault();
        fetch(url, {
            method: 'POST',
            headers: {
                "Authorization": 'Bearer ' + localStorage.getItem('access_token'),
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                content: document.getElementById('content').value,
                page: document.getElementById('page').value
            })
        }).then(() => {
            alert('등록 완료되었습니다.');
            location.replace(`/books/${bookId}/quotes`);
        })
        .catch(error => {
            alert.error('오류가 발생하였습니다:', error);
        });
    });
}



// 쿠키를 가져오는 함수
function getCookie(key) {
    var result = null;
    var cookie = document.cookie.split(';');
    cookie.some(function (item) {
        item = item.replace(' ', '');

        var dic = item.split('=');

        if (key === dic[0]) {
            result = dic[1];
            return true;
        }
    });
    return result;
}
function success() {
            alert('등록 완료되었습니다.');
            location.replace(`/books/${bookId}/quotes`);
}

function fail() {
            alert('등록 실패했습니다.');
            location.replace(`/books/${bookId}/quotes`);
}

  //로그아웃
    document.getElementById('logout').addEventListener('click', function(event) {
    event.preventDefault(); // 기본 동작인 링크 이동을 막음
    localStorage.removeItem("access_token");
    document.cookie = "refresh_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
    window.location.href = '/';
});

</script>
</html>